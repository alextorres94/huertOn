<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>{% block title %}Huerton v2{% endblock %}</title>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

  <!--Fksjdahfkjlasdhflksjadhflkjsadfhflkjsdhaflkjashdf-->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

  <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" charset="utf-8"></script>
  <!-- Load Leaflet from CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0/leaflet.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0/leaflet.js"></script>

  <!-- Load geocoding plugin after Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.7.1/leaflet-geocoder-mapzen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.7.1/leaflet-geocoder-mapzen.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.3/leaflet.draw.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.3/leaflet.draw.css">

  <link rel="stylesheet" href="{{ asset('/css/style.css') }}">


  <!--form rrss-->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css" />
  <link rel="stylesheet" type="text/css" href="{{ asset('/css/demo.css') }}" />
  <link rel="stylesheet" type="text/css" href="{{ asset('/css/set2.css') }}" />

  {% block stylesheets %}
  {% endblock %}
  <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}" />
</head>
<body>
  <!-- Image and text -->
  <nav class="navbar navbar-light bg-faded">
    <a class="navbar-brand" href="#">
      <img src="http://parcellesnostres.com/wp-content/uploads/2016/06/cropped-logo-parcelles.png" width="30" height="30" class="d-inline-block align-top" alt="">
    </a>
    <ul id="btn-save-exit" class="nav navbar-nav float-xs-right float-sm-right float-md-right float-lg-right">
      <li class="nav-item">
        <div id="loading" style="display: none;" class="loading"></div>
      </li>
      <li class="nav-item">
        <span id="loading-text" style="display: none;" class="navbar-text">
          Guardando...
        </span>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Guardar y salir</a>
      </li>
    </ul>
  </nav>

  <progress id="progressbar" class="progress" max="100" aria-describedby="example-caption-2"></progress>

  <div class="container-fluid">
    <input type="text" id="orchard-id" hidden="hidden">
    {% block body %}{% endblock %}

    {% block botones %}
      <div class="fixed-buttons row">
        <button id="btn-atras" type="button" class="btn btn-secondary col-xs-6 col-sm-6 col-md-6 col-lg-6">Atrás</button>
        <button id="btn-siguiente" type="submit" class="btn btn-primary col-xs-6 col-sm-6 col-md-6 col-lg-6">Siguiente</button>
      </div>
    {% endblock %}
  </div>

  <script type="text/javascript">

  if($('.required').length === 0) {
    $("#btn-siguiente").html('Ahora no');
  }

  window.onbeforeunload = function() {
    localStorage.setItem('lastProgress', $('#progressbar').val());
  }

  $('form :input:not(:checkbox):not(:button)').focusin(function() {
    var este = $(this).attr('id');
    console.log('este '+este);
    var inputs = $('.required');
    inputs.each(function(index) {
      console.log($(this).attr('id'));
      if(este == $(this).attr('id')) {
        console.log('ok');
        console.log(index);
        return false;
      }else {
        if($(this).val() == '') {
          $(this).prev().prev().tooltip('show');
          $(this).css('border-color', '#ff0000');
        }
      }
    });
  });

  var form =  {};

  $('#btn-siguiente, #btn-save-exit').on('click', function() {
    var valid = true;
    $('.required').each(function() {
      if($(this).val() == '') {
        $(this).prev().prev().tooltip('show');
        $(this).css('border-color', '#ff0000');
        valid = false;
      }
    });

    if(valid) {
      $("#loading, #loading-text").fadeIn("slow");
      $("form :input:not(:checkbox):not(:button)").each(function(){
        console.log($(this).val());
        form[$(this).attr('id')] = $(this).val();
      });

      form['id'] = $('#orchard-id').val();
      console.log('Este és el formulario'+form);


      //FUNCION BOTON SIGUIENTE
      $.ajax({
        type: 'POST',
        url: '/orchard/insert',
        data: form,
        success: function(data) {
          $("#loading, #loading-text").fadeOut("slow", function() {
            $("#loading-text").text("Guardado").fadeIn('slow');
          });
          console.log('success');
          window.location.href = '/orchard/step/'+data.redirect;
        },
        error: function(jqXHR, exception) {
          $("#loading, #loading-text").fadeOut("slow", function() {
            $("#loading-text").text("Guardado").fadeIn('slow');
          });
          if (jqXHR.status === 0) {
                alert('Not connect.\n Verify Network.');
            } else if (jqXHR.status == 404) {
                alert('Requested page not found. [404]');
            } else if (jqXHR.status == 500) {
                alert('Internal Server Error [500].');
            } else if (exception === 'parsererror') {
                alert('Requested JSON parse failed.');
            } else if (exception === 'timeout') {
                alert('Time out error.');
            } else if (exception === 'abort') {
                alert('Ajax request aborted.');
            } else {
                alert('Uncaught Error.\n' + jqXHR.responseText);
            }
          console.log('error');
        }
      });

      return false;
    }

  });

  //FUNCION BOTON ATRAS
  $('#btn-atras').on('click', function() {
    $("#loading, #loading-text").fadeIn("slow");
    $("form :input:not(:checkbox):not(:button)").each(function(){
      console.log($(this).val());
      form[$(this).attr('id')] = $(this).val();
    });

    form['id'] = $('#orchard-id').val();
    console.log('Este és el formulario'+form);


    $.ajax({
      type: 'POST',
      dataType: 'json',
      url: '/orchard/insert',
      data: form,
      success: function() {
        $("#loading, #loading-text").fadeOut("slow", function() {
          $("#loading-text").text("Guardado").fadeIn('slow');
        });
        if($('#Step').val() == '12' || $('#Step').val() == '22') {
          window.location.href = '/orchard/create'
        }else {
          var step = parseInt($('#Step').val())-2;
          console.log('redirigiendo a '+$('#Step').val());
          window.location.href = '/orchard/step/' + step.toString();
        }
      }
    });
  });

  // $("form input").change(function(){
  //   console.log('Validando');
  //   validateForm();
  // });
  //
  // $("form input").keyup(function(){
  //   console.log('Validando');
  //   validateForm();
  // });
  //
  // function validateForm() {
  //   var empty = false;
  //   $('form input').each(function() {
  //     if ($(this).val().length == 0) {
  //       empty = true;
  //     }
  //   });
  //
  //   if (empty) {
  //     $('#btn-siguiente').attr('disabled', 'disabled');
  //   } else {
  //     $('#btn-siguiente').removeAttr('disabled');
  //   }
  // }

  </script>

  {% block javascripts %}{% endblock %}

</body>
</html>
