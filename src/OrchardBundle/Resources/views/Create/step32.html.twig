{% extends '::step-base.html.twig' %}

{% block body %}

<div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-5 ">
		<form>
			<div class="form-group steps-left-12 col-xs-12 col-sm-12 col-md-12 col-lg-5">
				<label><h4>¿Qué servicios ofreces?</h4></label><br>

				<div class="row">
					{% for orchardService in orchardServices %}

					<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
						<label class="custom-control custom-checkbox">
							<input id="{{ orchardService.id }}" type="checkbox" class="custom-control-input" {% if orchardService in orchard.orchardService %} checked {% endif %}>
							<span class="custom-control-indicator"></span>
							<span class="custom-control-description">{{ orchardService.name }}</span>
						</label>
					</div>

					{% endfor %}
				</div>

				<br>
				<div class="row">
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<label class="custom-control custom-checkbox">
							<input id="cb-new-service" type="checkbox" class="custom-control-input">
							<span class="custom-control-indicator"></span>
							<span class="custom-control-description">Sugiérenos un servicio</span>
						</label>
						<input type="text" class="form-control" id="Service" placeholder="Escribe aquí el servicio" hidden>

						<br>
						<button id="btn-enviar" class="btn btn-primary col-xs-6 col-sm-6 col-md-6 col-lg-6" hidden>Enviar</button>
					</div>
				</div>

			</div>

			<input type="text" id="Step" hidden="hidden" value="33">

		</form>

		<div class="fixed-buttons">
			<button id="btn-atras" type="button" class="btn btn-secondary col-xs-6 col-sm-6 col-md-6 col-lg-6">Atrás</button>
			<button id="btn-siguiente" type="submit" class="btn btn-primary col-xs-6 col-sm-6 col-md-6 col-lg-6">Siguiente</button>
		</div>

	</div>

	<div class="col-xs-12 col-sm-12 col-md-6 col-lg-7 steps-right">
		<img src="{{ asset('img/step12.png') }}" width="100%" height="100%">
	</div>

</div>

{% endblock %}

{% block javascripts %}

<script type="text/javascript">

$(function() {

	$('#progressbar').val(localStorage.getItem('lastProgress')).animate({'value': 66 + '%','aria-valuenow': 66}, {duration: 400, easing: 'linear'});

	//FUNCION BOTON SIGUIENTE
	$('#btn-siguiente').on('click', function() {

			var orchard_services = [];
			initSave(orchard_services);

			$.ajax({
				type: 'POST',
				url: '/orchard/create/insert/checkbox/{{ orchard.id }}/OrchardService',
				data: { 'OrchardService': orchard_services },
				success: function(data) {
					saveAnimation();
					console.log('success');
					window.location.href = '/orchard/create/step/' + data.redirect + '/{{ orchard.id }}';
				},
				error: function(jqXHR, exception) {
					saveAnimation();
					if (jqXHR.status === 0) {
						alert('Not connect.\n Verify Network.');
					} else if (jqXHR.status == 404) {
						alert('Requested page not found. [404]');
					} else if (jqXHR.status == 500) {
						alert('Internal Server Error [500].');
					} else if (exception === 'parsererror') {
						alert('Requested JSON parse failed.');
					} else if (exception === 'timeout') {
						alert('Time out error.');
					} else if (exception === 'abort') {
						alert('Ajax request aborted.');
					} else {
						alert('Uncaught Error.\n' + jqXHR.responseText);
					}
					console.log('error');
				}
			});

			return false;

	});

	//FUNCION BOTON ATRAS
	$('#btn-atras').on('click', function() {

			var orchard_services = [];
			initSave(orchard_services);

			$.ajax({
				type: 'POST',
				dataType: 'json',
				url: '/orchard/create/insert/checkbox/{{ orchard.id }}/OrchardService',
				data: { 'OrchardService': orchard_services },
				success: function() {
					saveAnimation();
					window.location.href = '/orchard/create/step/31/{{ orchard.id }}';
				}
			});

	});

	//FUNCION BOTON GUARDAR Y SALIR
	$('#btn-save-exit').on('click', function() {

			var orchard_services = [];
			initSave(orchard_services);

			$.ajax({
				type: 'POST',
				url: '/orchard/create/insert/checkbox/{{ orchard.id }}/OrchardService',
				data: { 'OrchardService': orchard_services },
				success: function(data) {
					saveAnimation();
					console.log('success');
					window.location.href = '/orchard/create/steps/{{ orchard.id }}';
				},
				error: function(jqXHR, exception) {
					saveAnimation();
					if (jqXHR.status === 0) {
						alert('Not connect.\n Verify Network.');
					} else if (jqXHR.status == 404) {
						alert('Requested page not found. [404]');
					} else if (jqXHR.status == 500) {
						alert('Internal Server Error [500].');
					} else if (exception === 'parsererror') {
						alert('Requested JSON parse failed.');
					} else if (exception === 'timeout') {
						alert('Time out error.');
					} else if (exception === 'abort') {
						alert('Ajax request aborted.');
					} else {
						alert('Uncaught Error.\n' + jqXHR.responseText);
					}
					console.log('error');
				}
			});

			return false;

	});

	function initSave(orchard_services) {
		$("#loading, #loading-text").fadeIn("slow");
		$(':checkbox:not(#cb-new-service):checked').each(function(){
			console.log($(this).attr('id'));
			orchard_services.push($(this).attr('id'));
		});
	}

	function saveAnimation() {
		$("#loading, #loading-text").fadeOut("slow", function() {
			$("#loading-text").text("Guardado").fadeIn('slow');
		});
	}

	//FUNCIÓN QUE COMPRUEBA SI SE INSERTAN REGISTROS
	$(':checkbox:not(#cb-new-service)').change(function() {
		var checkeado = false;
		if(this.checked) {
			$('#btn-siguiente').html('Siguiente')
		}else {
			if($(':checkbox').each(function() {
				if(this.checked) {
					checkeado = true;
				}
			}));

			if(!checkeado) {
				$('#btn-siguiente').html('Ahora no');
			}
		}
	});

	$(':checkbox:not(#cb-new-service)').each(function() {
		if(this.checked) {
			console.log('checkeado');
			$('#btn-siguiente').html('Siguiente')
 		}
	});

	initSuggest();

	function initSuggest() {
		//FUNCION PARA MOSTRAR/OCULTAR INPUT SUGERENCIA
		$('#cb-new-service').click(function() {
			this.checked ? $('#Service').removeAttr('hidden') : $('#Service').attr('hidden', 'hidden');
			this.checked ? $('#btn-enviar').removeAttr('hidden') : $('#btn-enviar').attr('hidden', 'hidden');
		});

		//borramos los handlers del onclick para evitar que se clike varias veces
		//añade gestion de AJAX al boton enviar al entrar a la pagina por si el campo tipo ya estaba rellenado anteriormente
		prepareSend();

		//borramos los handlers del onclick para evitar que se clike varias veces
		//añade gestion de AJAX al boton enviar cada vez que se escriba en el campo de tipo
		$('#Service').keyup(function() {
			prepareSend();
		});
	}

	function prepareSend() {
		$('#btn-enviar').off('click');
		$('#btn-enviar').on('click', function() {
			if($('#Type').val()) {
				$.ajax({
					type: 'POST',
					url: '/orchard/suggest/send/'+$('#Type').val(),
					success: function(data) {
						console.log('success');
						$('#myModal').modal('show');
					},
					error: function(jqXHR, exception) {
						if (jqXHR.status === 0) {
							alert('Not connect.\n Verify Network.');
						} else if (jqXHR.status == 404) {
							alert('Requested page not found. [404]');
						} else if (jqXHR.status == 500) {
							alert('Internal Server Error [500].');
						} else if (exception === 'parsererror') {
							alert('Requested JSON parse failed.');
						} else if (exception === 'timeout') {
							alert('Time out error.');
						} else if (exception === 'abort') {
							alert('Ajax request aborted.');
						} else {
							alert('Uncaught Error.\n' + jqXHR.responseText);
						}
						console.log('error');
					}
				});
			}
			return false;
		});
	}

});
</script>
{% endblock %}
